---
services:
  volume-init:
    image: alpine:latest
    command:
      - "sh"
      - "-c"
      - "chown -R 100:101 /data/briefing /data/readwise /data/enrich-text /data/cvelist /data/zotero /data/miniflux /data/mapping"
    volumes:
      - briefing-data:/data/briefing
      - readwise-state:/data/readwise
      - enrich-text-state:/data/enrich-text
      - cvelist-state:/data/cvelist
      - zotero-state:/data/zotero
      - miniflux-state:/data/miniflux
      - mapping-data:/data/mapping
    restart: "no"

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.9
    labels:
      - com.monitoring.enable=true
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms8g -Xmx8g
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    labels:
      - com.monitoring.enable=true
    command: server /data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:8.4.0
    labels:
      - com.monitoring.enable=true
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  rabbitmq:
    image: rabbitmq:4.2-management
    labels:
      - com.monitoring.enable=true
    ulimits:
      nofile:
        soft: 65536
        hard: 131072
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./services/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres:
    image: postgres:15
    labels:
      - com.monitoring.enable=true
    environment:
      - POSTGRES_USER=opencti
      - POSTGRES_PASSWORD=opencti
      - POSTGRES_DB=opencti
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U opencti"]
      interval: 30s
      timeout: 10s
      retries: 5

  opencti:
    image: opencti/platform:latest
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - APP__PORT=${OPENCTI_APP__PORT:-8080}
      - APP__BASE_URL=${OPENCTI_APP__WEB_URL:-http://localhost:8080}
      - APP__ADMIN__EMAIL=${OPENCTI_APP__ADMIN__EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_APP__ADMIN__PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - APP__APP_LOGS__LEVEL=${OPENCTI_APP__APP_LOGS__LEVEL:-info}
      - APP__APP_LOGS__FORMAT=${OPENCTI_APP__APP_LOGS__FORMAT:-plain}
      - APP__HEALTH_ACCESS_KEY=${OPENCTI_HEALTHCHECK_ACCESS_KEY}
      - REDIS__HOSTNAME=${OPENCTI_APP__REDIS__HOSTNAME:-redis}
      - REDIS__PORT=${OPENCTI_APP__REDIS__PORT:-6379}
      - RABBITMQ__HOSTNAME=${OPENCTI_APP__RABBITMQ__HOSTNAME:-rabbitmq}
      - RABBITMQ__PORT=${OPENCTI_APP__RABBITMQ__PORT:-5672}
      - RABBITMQ__MANAGEMENT_PORT=${OPENCTI_APP__RABBITMQ__MANAGEMENT_PORT:-15672}
      - RABBITMQ__USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - ELASTICSEARCH__URL=${OPENCTI_APP__ELASTICSEARCH__URL:-http://elasticsearch:9200}
      - ELASTICSEARCH__NUMBER_OF_REPLICAS=0
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO__SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - DATABASE__URL=${OPENCTI_APP__DATABASE__URL}
    depends_on:
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "127.0.0.1:${OPENCTI_APP_PORT:-8080}:8080"
    volumes:
      - opencti-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- \"http://localhost:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY}\" > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10

  opencti-worker:
    image: opencti/worker:latest
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - WORKER_LOG_LEVEL=${OPENCTI_WORKER_LOG_LEVEL:-info}
    depends_on:
      opencti:
        condition: service_healthy
      briefing:
        condition: service_healthy

  opencti-init:
    build:
      context: services/opencti-init
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_USER_EMAIL=${OPENCTI_USER_EMAIL}
      - OPENCTI_USER_PASSWORD=${OPENCTI_USER_PASSWORD}
      - OPENCTI_USER_NAME=${OPENCTI_USER_NAME}
      - OPENCTI_USER_ROLE=${OPENCTI_USER_ROLE:-Analyst}
    depends_on:
      opencti:
        condition: service_healthy
      briefing:
        condition: service_healthy

  briefing:
    build:
      context: services/briefing
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_EXTERNAL_URL=${OPENCTI_EXTERNAL_URL:-}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - BRIEFING_DB_PATH=${BRIEFING_DB_PATH:-/data/briefing.sqlite}
      - BRIEFING_TIMEZONE=${BRIEFING_TIMEZONE:-Europe/Stockholm}
      - BRIEFING_SCHEDULE_HOUR=${BRIEFING_SCHEDULE_HOUR:-4}
      - BRIEFING_SCHEDULE_MINUTE=${BRIEFING_SCHEDULE_MINUTE:-5}
      - BRIEFING_BASE_URL=${BRIEFING_BASE_URL:-http://localhost:8088}
      - MINIFLUX_URL=${MINIFLUX_URL}
      - MINIFLUX_API_KEY=${MINIFLUX_API_KEY}
      - READWISE_API_KEY=${READWISE_API_KEY}
      - ZOTERO_API_KEY=${ZOTERO_API_KEY}
      - ZOTERO_LIBRARY_ID=${ZOTERO_LIBRARY_ID}
      - ZOTERO_LIBRARY_TYPE=${ZOTERO_LIBRARY_TYPE:-user}
    ports:
      - "127.0.0.1:8088:8088"
    volumes:
      - briefing-data:/data
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8088/health').read()\""]
      interval: 30s
      timeout: 5s
      retries: 5

  connector-miniflux:
    build:
      context: services/connectors
      dockerfile: miniflux/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MINIFLUX_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=miniflux
      - CONNECTOR_SCOPE=miniflux
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL_SECONDS=${MINIFLUX_RUN_INTERVAL_SECONDS:-1200}
      - MINIFLUX_URL=${MINIFLUX_URL}
      - MINIFLUX_API_KEY=${MINIFLUX_API_KEY}
      - TI_MAPPING_DB=${TI_MAPPING_DB:-/data/mapping/ti-mapping.sqlite}
    volumes:
      - miniflux-state:/data
      - mapping-data:/data/mapping
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
      briefing:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-readwise:
    build:
      context: services/connectors
      dockerfile: readwise/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${READWISE_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=readwise
      - CONNECTOR_SCOPE=readwise
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL_SECONDS=${READWISE_RUN_INTERVAL_SECONDS:-1800}
      - READWISE_API_KEY=${READWISE_API_KEY}
      - TI_MAPPING_DB=${TI_MAPPING_DB:-/data/mapping/ti-mapping.sqlite}
    volumes:
      - readwise-state:/data
      - mapping-data:/data/mapping
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
      briefing:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-zotero:
    build:
      context: services/connectors
      dockerfile: zotero/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${ZOTERO_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=zotero
      - CONNECTOR_SCOPE=zotero
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL_SECONDS=${ZOTERO_RUN_INTERVAL_SECONDS:-3600}
      - ZOTERO_API_KEY=${ZOTERO_API_KEY}
      - ZOTERO_LIBRARY_ID=${ZOTERO_LIBRARY_ID}
      - ZOTERO_LIBRARY_TYPE=${ZOTERO_LIBRARY_TYPE:-user}
      - TI_MAPPING_DB=${TI_MAPPING_DB:-/data/mapping/ti-mapping.sqlite}
    volumes:
      - zotero-state:/data
      - mapping-data:/data/mapping
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
      briefing:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-enrich-text:
    build:
      context: services/connectors
      dockerfile: enrich_text/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${ENRICH_TEXT_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=enrich-text
      - CONNECTOR_SCOPE=text-enrichment
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL_SECONDS=${ENRICH_RUN_INTERVAL_SECONDS:-1800}
      - ENRICH_LOOKBACK_DAYS=${ENRICH_LOOKBACK_DAYS:-7}
      - TI_ENRICH_SOURCES=${TI_ENRICH_SOURCES:-miniflux,readwise,zotero}
      - ENRICHMENT_LLM_ENABLED=${ENRICHMENT_LLM_ENABLED:-true}
      - ENRICHMENT_LLM_ENDPOINT=${ENRICHMENT_LLM_ENDPOINT:-http://ollama:11434/api/generate}
      - ENRICHMENT_LLM_MODEL=${ENRICHMENT_LLM_MODEL:-llama3.2:3b}
      - ENRICHMENT_SUMMARY_ENABLED=${ENRICHMENT_SUMMARY_ENABLED:-false}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - enrich-text-state:/data
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  ollama:
    image: ollama/ollama:latest
    labels:
      - com.monitoring.enable=true
    environment:
      - OLLAMA_HOST=0.0.0.0:11434
    volumes:
      - ollama-data:/root/.ollama
    mem_limit: ${OLLAMA_MEM_LIMIT:-4g}
    cpus: ${OLLAMA_CPUS:-2.0}
    healthcheck:
      test: ["CMD-SHELL", "ollama list >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    entrypoint: ["/bin/sh", "-c"]
    command:
      - "ollama serve & sleep 2; ollama pull ${ENRICHMENT_LLM_MODEL:-llama3.2:3b}; wait"

  connector-cvelist:
    build:
      context: services/connectors
      dockerfile: cvelist/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${CVELIST_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=CVE List V5
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_LOG_LEVEL=info
      - CVELIST_REPO_URL=${CVELIST_REPO_URL:-https://github.com/CVEProject/cvelistV5.git}
      - CVELIST_BRANCH=${CVELIST_BRANCH:-main}
      - CONNECTOR_RUN_INTERVAL_SECONDS=${CVELIST_RUN_INTERVAL_SECONDS:-3600}
      - HOME=/data
    command:
      - "sh"
      - "-c"
      - "git config --global --add safe.directory /data/cvelistV5 && exec python -m connector_cvelist.main"
    volumes:
      - cvelist-state:/data
    restart: unless-stopped
    depends_on:
      volume-init:
        condition: service_completed_successfully
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-cisa-kev:
    image: opencti/connector-cisa-known-exploited-vulnerabilities:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${CISA_KEV_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=CISA KEV
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=21600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - CISA_CATALOG_URL=${CISA_CATALOG_URL:-https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json}
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-mitre:
    image: opencti/connector-mitre:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MITRE_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MITRE ATT&CK
      - CONNECTOR_SCOPE=attack-pattern,intrusion-set,malware,tool,campaign,course-of-action,relationship,identity,location
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-threatfox:
    image: opencti/connector-threatfox:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${THREATFOX_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=abuse.ch ThreatFox
      - CONNECTOR_SCOPE=indicator,malware,threat-actor
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

#  connector-alienvault:
#    image: opencti/connector-alienvault:latest
#    env_file:
#      - .env
#    environment:
#      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
#      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
#      - CONNECTOR_ID=${ALIENVAULT_CONNECTOR_ID}
#      - CONNECTOR_TYPE=EXTERNAL_IMPORT
#      - CONNECTOR_NAME=AlienVault
#      - CONNECTOR_SCOPE=alienvault
#      - CONNECTOR_LOG_LEVEL=info
#      - CONNECTOR_DURATION_PERIOD=PT10M
#      - ALIENVAULT_BASE_URL=${ALIENVAULT_BASE_URL:-https://otx.alienvault.com}
#      - ALIENVAULT_API_KEY=${ALIENVAULT_API_KEY}
#      - ALIENVAULT_TLP=White
#      - ALIENVAULT_CREATE_OBSERVABLES=true
#      - ALIENVAULT_CREATE_INDICATORS=true
#      - ALIENVAULT_PULSE_START_TIMESTAMP=${ALIENVAULT_PULSE_START_TIMESTAMP:-2025-07-01T00:00:00}
#      - ALIENVAULT_REPORT_TYPE=threat-report
#      - ALIENVAULT_REPORT_STATUS=New
#      - ALIENVAULT_GUESS_MALWARE=false
#      - ALIENVAULT_GUESS_CVE=false
#      - ALIENVAULT_EXCLUDED_PULSE_INDICATOR_TYPES=FileHash-MD5,FileHash-SHA1
#      - ALIENVAULT_ENABLE_RELATIONSHIPS=true
#      - ALIENVAULT_ENABLE_ATTACK_PATTERNS_INDICATES=true
#      - ALIENVAULT_DEFAULT_X_OPENCTI_SCORE=50
#    restart: unless-stopped
#    depends_on:
#      opencti:
#        condition: service_healthy

  connector-urlhaus:
    image: opencti/connector-urlhaus:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${URLHAUS_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Abuse.ch URLhaus
      - CONNECTOR_SCOPE=urlhaus
      - CONNECTOR_LOG_LEVEL=info
      - URLHAUS_INTERVAL=3
      - URLHAUS_CSV_URL=https://urlhaus.abuse.ch/downloads/csv_recent/
      - URLHAUS_DEFAULT_X_OPENCTI_SCORE=80
      - URLHAUS_IMPORT_OFFLINE=true
      - URLHAUS_THREATS_FROM_LABELS=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-ransomwarelive:
    image: opencti/connector-ransomwarelive:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${RANSOMWARELIVE_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Ransomware Connector
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT10M
      - CONNECTOR_PULL_HISTORY=false
      - CONNECTOR_HISTORY_START_YEAR=2023
      - CONNECTOR_CREATE_THREAT_ACTOR=false
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-malpedia:
    image: opencti/connector-malpedia:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MALPEDIA_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Malpedia
      - CONNECTOR_SCOPE=malpedia
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_DURATION_PERIOD=PT24H
      - MALPEDIA_AUTH_KEY=${MALPEDIA_AUTH_KEY}
      - MALPEDIA_IMPORT_INTRUSION_SETS=true
      - MALPEDIA_IMPORT_YARA=true
      - MALPEDIA_CREATE_INDICATORS=true
      - MALPEDIA_CREATE_OBSERVABLES=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-malwarebazaar:
    image: opencti/connector-malwarebazaar:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MALWAREBAZAAR_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MalwareBazaar
      - CONNECTOR_SCOPE=StixFile
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT50M
      - MALWAREBAZAAR_API_BASE_URL=https://mb-api.abuse.ch/api/v1/
      - MALWAREBAZAAR_API_KEY=${MALWAREBAZAAR_API_KEY}
      - MALWAREBAZAAR_TLP_LEVEL=clear
      - MALWAREBAZAAR_X_OPENCTI_SCORE=100
      - MALWAREBAZAAR_INCLUDE_TAGS=exe,dll,docm,docx,doc,xls,xlsx,xlsm,js
      - MALWAREBAZAAR_INCLUDE_REPORTERS=
      - MALWAREBAZAAR_LABELS=malware-bazaar
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-abuse-ssl:
    image: opencti/connector-abuse-ssl:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${ABUSESSL_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Abuse.ch SSL Blacklist
      - CONNECTOR_SCOPE=abusessl
      - CONNECTOR_LOG_LEVEL=info
      - ABUSESSL_URL=https://sslbl.abuse.ch/blacklist/sslipblacklist.csv
      - ABUSESSL_INTERVAL=360
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-yara:
    image: opencti/connector-yara:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${YARA_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=YARA
      - CONNECTOR_SCOPE=Artifact
      - CONNECTOR_AUTO=true
      - CONNECTOR_CONFIDENCE_LEVEL=80
      - CONNECTOR_LOG_LEVEL=info
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed-rwx:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_RWX_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed RWX
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_RWX_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed-botvrij:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_BOTVRIJ_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed Botvrij
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_BOTVRIJ_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed-rosti:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_ROSTI_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed Rosti
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_ROSTI_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-first-epss:
    image: opencti/connector-first-epss:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${FIRST_EPSS_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=FIRST EPSS
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - FIRST_EPSS_API_KEY=${FIRST_EPSS_API_KEY}
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-virustotal:
    image: opencti/connector-virustotal:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${VIRUSTOTAL_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_SCOPE=StixFile,Artifact,IPv4-Addr,IPv6-Addr,Url,Domain-Name
      - CONNECTOR_NAME=VirusTotal
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - VIRUSTOTAL_TOKEN=${VIRUSTOTAL_TOKEN}
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-shodan-internetdb:
    image: opencti/connector-shodan-internetdb:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${SHODAN_INTERNETDB_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Shodan InternetDB
      - CONNECTOR_SCOPE=ipv4-addr,hostname
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - SHODAN_TOKEN=${SHODAN_TOKEN}
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-shodan:
    image: opencti/connector-shodan:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${SHODAN_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=Shodan
      - CONNECTOR_SCOPE=ipv4-addr,hostname
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - SHODAN_TOKEN=${SHODAN_TOKEN}
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-opencti-datasets:
    image: opencti/connector-opencti:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${OPENCTI_DATASETS_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=OpenCTI Datasets
      - CONNECTOR_SCOPE=collection
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy

  connector-awesome-annual-security-reports:
    build:
      context: services/connectors
      dockerfile: awesome_annual_security_reports/Dockerfile
    labels:
      - com.monitoring.enable=true
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${AWESOME_ASR_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Awesome Annual Security Reports
      - CONNECTOR_SCOPE=awesome-annual-security-reports
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL_SECONDS=${AWESOME_ASR_RUN_INTERVAL_SECONDS:-21600}
      - AWESOME_ASR_GITHUB_OWNER=${AWESOME_ASR_GITHUB_OWNER:-jacobdjwilson}
      - AWESOME_ASR_GITHUB_REPO=${AWESOME_ASR_GITHUB_REPO:-awesome-annual-security-reports}
      - AWESOME_ASR_GITHUB_REF=${AWESOME_ASR_GITHUB_REF:-main}
      - AWESOME_ASR_GITHUB_TOKEN=${AWESOME_ASR_GITHUB_TOKEN}
      - AWESOME_ASR_MAX_MARKDOWN_BYTES=${AWESOME_ASR_MAX_MARKDOWN_BYTES:-2000000}
      - TI_MAPPING_DB=${TI_MAPPING_DB:-/data/mapping/ti-mapping.sqlite}
    volumes:
      - awesome-annual-state:/data
      - mapping-data:/data/mapping
    restart: unless-stopped
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  elasticsearch-data:
  minio-data:
  redis-data:
  rabbitmq-data:
  postgres-data:
  opencti-data:
  briefing-data:
  miniflux-state:
  readwise-state:
  zotero-state:
  enrich-text-state:
  mapping-data:
  cvelist-state:
  awesome-annual-state:
  ollama-data:
