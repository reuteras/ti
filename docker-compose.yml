---
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.9
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health?wait_for_status=yellow&timeout=1s >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    command: server /data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:8.4.0
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  rabbitmq:
    image: rabbitmq:4.2-management
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=opencti
      - POSTGRES_PASSWORD=opencti
      - POSTGRES_DB=opencti
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U opencti"]
      interval: 30s
      timeout: 10s
      retries: 5

  opencti:
    image: opencti/platform:6.9.8
    env_file:
      - .env
    environment:
      - APP__PORT=${OPENCTI_APP__PORT:-8080}
      - APP__BASE_URL=${OPENCTI_APP__WEB_URL:-http://localhost:8080}
      - APP__ADMIN__EMAIL=${OPENCTI_APP__ADMIN__EMAIL}
      - APP__ADMIN__PASSWORD=${OPENCTI_APP__ADMIN__PASSWORD}
      - APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - APP__APP_LOGS__LEVEL=${OPENCTI_APP__APP_LOGS__LEVEL:-info}
      - APP__APP_LOGS__FORMAT=${OPENCTI_APP__APP_LOGS__FORMAT:-plain}
      - APP__HEALTH_ACCESS_KEY=${OPENCTI_HEALTHCHECK_ACCESS_KEY}
      - REDIS__HOSTNAME=${OPENCTI_APP__REDIS__HOSTNAME:-redis}
      - REDIS__PORT=${OPENCTI_APP__REDIS__PORT:-6379}
      - RABBITMQ__HOSTNAME=${OPENCTI_APP__RABBITMQ__HOSTNAME:-rabbitmq}
      - RABBITMQ__PORT=${OPENCTI_APP__RABBITMQ__PORT:-5672}
      - RABBITMQ__MANAGEMENT_PORT=${OPENCTI_APP__RABBITMQ__MANAGEMENT_PORT:-15672}
      - RABBITMQ__USERNAME=${RABBITMQ_DEFAULT_USER}
      - RABBITMQ__PASSWORD=${RABBITMQ_DEFAULT_PASS}
      - ELASTICSEARCH__URL=${OPENCTI_APP__ELASTICSEARCH__URL:-http://elasticsearch:9200}
      - ELASTICSEARCH__NUMBER_OF_REPLICAS=0
      - MINIO__ENDPOINT=minio
      - MINIO__PORT=9000
      - MINIO__USE_SSL=false
      - MINIO__ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO__SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - DATABASE__URL=${OPENCTI_APP__DATABASE__URL}
    depends_on:
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
    ports:
      - "${OPENCTI_APP_PORT:-8080}:8080"
    volumes:
      - opencti-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- \"http://localhost:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY}\" > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10

  opencti-worker:
    image: opencti/worker:6.9.8
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - WORKER_LOG_LEVEL=${OPENCTI_APP__APP_LOGS__LEVEL:-info}
    depends_on:
      opencti:
        condition: service_healthy

  opencti-init:
    build:
      context: services/opencti-init
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_MINIFLUX_TOKEN=${OPENCTI_MINIFLUX_TOKEN}
      - OPENCTI_READWISE_TOKEN=${OPENCTI_READWISE_TOKEN}
      - OPENCTI_ZOTERO_TOKEN=${OPENCTI_ZOTERO_TOKEN}
      - OPENCTI_USER_EMAIL=${OPENCTI_USER_EMAIL}
      - OPENCTI_USER_PASSWORD=${OPENCTI_USER_PASSWORD}
      - OPENCTI_USER_NAME=${OPENCTI_USER_NAME}
      - OPENCTI_USER_ROLE=${OPENCTI_USER_ROLE:-Analyst}
    depends_on:
      opencti:
        condition: service_healthy

  briefing:
    build:
      context: services/briefing
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - BRIEFING_DB_PATH=${BRIEFING_DB_PATH:-/data/briefing.sqlite}
      - BRIEFING_TIMEZONE=${BRIEFING_TIMEZONE:-Europe/Stockholm}
      - BRIEFING_SCHEDULE_HOUR=${BRIEFING_SCHEDULE_HOUR:-4}
      - BRIEFING_SCHEDULE_MINUTE=${BRIEFING_SCHEDULE_MINUTE:-5}
      - BRIEFING_BASE_URL=${BRIEFING_BASE_URL:-http://localhost:8088}
      - MINIFLUX_URL=${MINIFLUX_URL}
      - MINIFLUX_TOKEN=${MINIFLUX_TOKEN}
      - READWISE_TOKEN=${READWISE_TOKEN}
      - ZOTERO_API_KEY=${ZOTERO_API_KEY}
      - ZOTERO_LIBRARY_ID=${ZOTERO_LIBRARY_ID}
      - ZOTERO_LIBRARY_TYPE=${ZOTERO_LIBRARY_TYPE:-user}
    ports:
      - "8088:8088"
    volumes:
      - briefing-data:/data
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8088/health').read()\""]
      interval: 30s
      timeout: 5s
      retries: 5

  connector-miniflux:
    build:
      context: services/connectors
      dockerfile: miniflux/Dockerfile
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_MINIFLUX_TOKEN}
      - CONNECTOR_NAME=miniflux
      - CONNECTOR_SCOPE=miniflux
      - CONNECTOR_RUN_INTERVAL_SECONDS=${CONNECTOR_RUN_INTERVAL_SECONDS:-600}
      - MINIFLUX_URL=${MINIFLUX_URL}
      - MINIFLUX_TOKEN=${MINIFLUX_TOKEN}
    volumes:
      - miniflux-state:/data
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-readwise:
    build:
      context: services/connectors
      dockerfile: readwise/Dockerfile
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_READWISE_TOKEN}
      - CONNECTOR_NAME=readwise
      - CONNECTOR_SCOPE=readwise
      - CONNECTOR_RUN_INTERVAL_SECONDS=${CONNECTOR_RUN_INTERVAL_SECONDS:-600}
      - READWISE_TOKEN=${READWISE_TOKEN}
    volumes:
      - readwise-state:/data
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-zotero:
    build:
      context: services/connectors
      dockerfile: zotero/Dockerfile
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - OPENCTI_TOKEN=${OPENCTI_ZOTERO_TOKEN}
      - CONNECTOR_NAME=zotero
      - CONNECTOR_SCOPE=zotero
      - CONNECTOR_RUN_INTERVAL_SECONDS=${CONNECTOR_RUN_INTERVAL_SECONDS:-600}
      - ZOTERO_API_KEY=${ZOTERO_API_KEY}
      - ZOTERO_LIBRARY_ID=${ZOTERO_LIBRARY_ID}
      - ZOTERO_LIBRARY_TYPE=${ZOTERO_LIBRARY_TYPE:-user}
    volumes:
      - zotero-state:/data
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-cvelist:
    build:
      context: services/connectors
      dockerfile: cvelist/Dockerfile
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_ADMIN_TOKEN=${OPENCTI_ADMIN_TOKEN}
      - OPENCTI_APP__ADMIN__TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CVELIST_REPO_URL=${CVELIST_REPO_URL:-https://github.com/CVEProject/cvelistV5.git}
      - CVELIST_BRANCH=${CVELIST_BRANCH:-main}
      - CVELIST_RUN_INTERVAL_SECONDS=${CVELIST_RUN_INTERVAL_SECONDS:-3600}
    volumes:
      - cvelist-state:/data
    depends_on:
      opencti:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)'"]
      interval: 30s
      timeout: 5s
      retries: 3

  connector-cisa-kev:
    image: opencti/connector-cisa-known-exploited-vulnerabilities:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${CISA_KEV_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=CISA KEV
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=21600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-mitre:
    image: opencti/connector-mitre:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MITRE_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MITRE ATT&CK
      - CONNECTOR_SCOPE=attack-pattern,intrusion-set,malware,tool,campaign,course-of-action,relationship,identity,location
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-threatfox:
    image: opencti/connector-threatfox:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${THREATFOX_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=abuse.ch ThreatFox
      - CONNECTOR_SCOPE=indicator,malware,threat-actor
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-alienvault:
    image: opencti/connector-alienvault:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${ALIENVAULT_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=AlienVault
      - CONNECTOR_SCOPE=alienvault
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT30M
      - ALIENVAULT_BASE_URL=${ALIENVAULT_BASE_URL:-https://otx.alienvault.com}
      - ALIENVAULT_API_KEY=${ALIENVAULT_API_KEY}
      - ALIENVAULT_TLP=White
      - ALIENVAULT_CREATE_OBSERVABLES=true
      - ALIENVAULT_CREATE_INDICATORS=true
      - ALIENVAULT_PULSE_START_TIMESTAMP=2020-05-01T00:00:00
      - ALIENVAULT_REPORT_TYPE=threat-report
      - ALIENVAULT_REPORT_STATUS=New
      - ALIENVAULT_GUESS_MALWARE=false
      - ALIENVAULT_GUESS_CVE=false
      - ALIENVAULT_EXCLUDED_PULSE_INDICATOR_TYPES=FileHash-MD5,FileHash-SHA1
      - ALIENVAULT_ENABLE_RELATIONSHIPS=true
      - ALIENVAULT_ENABLE_ATTACK_PATTERNS_INDICATES=true
      - ALIENVAULT_DEFAULT_X_OPENCTI_SCORE=50
    depends_on:
      opencti:
        condition: service_healthy

  connector-urlhaus:
    image: opencti/connector-urlhaus:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${URLHAUS_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Abuse.ch URLhaus
      - CONNECTOR_SCOPE=urlhaus
      - CONNECTOR_LOG_LEVEL=info
      - URLHAUS_INTERVAL=3
      - URLHAUS_CSV_URL=https://urlhaus.abuse.ch/downloads/csv_recent/
      - URLHAUS_DEFAULT_X_OPENCTI_SCORE=80
      - URLHAUS_IMPORT_OFFLINE=true
      - URLHAUS_THREATS_FROM_LABELS=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-ransomwarelive:
    image: opencti/connector-ransomwarelive:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${RANSOMWARELIVE_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Ransomware Connector
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT10M
      - CONNECTOR_PULL_HISTORY=false
      - CONNECTOR_HISTORY_START_YEAR=2023
      - CONNECTOR_CREATE_THREAT_ACTOR=false
    depends_on:
      opencti:
        condition: service_healthy

  connector-montysecurity-c2-tracker:
    image: opencti/connector-montysecurity-c2-tracker:latest
    env_file:
      - .env
    environment:
      - opencti_url=${OPENCTI_URL:-http://opencti:8080}
      - opencti_c2tracker_token=${MONTYSECURITY_C2TRACKER_TOKEN}
    depends_on:
      opencti:
        condition: service_healthy

  connector-malpedia:
    image: opencti/connector-malpedia:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MALPEDIA_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Malpedia
      - CONNECTOR_SCOPE=malpedia
      - CONNECTOR_LOG_LEVEL=error
      - CONNECTOR_DURATION_PERIOD=PT24H
      - MALPEDIA_AUTH_KEY=${MALPEDIA_AUTH_KEY}
      - MALPEDIA_IMPORT_INTRUSION_SETS=true
      - MALPEDIA_IMPORT_YARA=true
      - MALPEDIA_CREATE_INDICATORS=true
      - MALPEDIA_CREATE_OBSERVABLES=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-malwarebazaar:
    image: opencti/connector-malwarebazaar:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MALWAREBAZAAR_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MalwareBazaar
      - CONNECTOR_SCOPE=StixFile
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT50M
      - MALWAREBAZAAR_API_BASE_URL=https://mb-api.abuse.ch/api/v1/
      - MALWAREBAZAAR_API_KEY=${MALWAREBAZAAR_API_KEY}
      - MALWAREBAZAAR_TLP_LEVEL=clear
      - MALWAREBAZAAR_X_OPENCTI_SCORE=100
      - MALWAREBAZAAR_INCLUDE_TAGS=exe,dll,docm,docx,doc,xls,xlsx,xlsm,js
      - MALWAREBAZAAR_INCLUDE_REPORTERS=
      - MALWAREBAZAAR_LABELS=malware-bazaar
    depends_on:
      opencti:
        condition: service_healthy

  connector-abuse-ssl:
    image: opencti/connector-abuse-ssl:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${ABUSESSL_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Abuse.ch SSL Blacklist
      - CONNECTOR_SCOPE=abusessl
      - CONNECTOR_LOG_LEVEL=info
      - ABUSESSL_URL=https://sslbl.abuse.ch/blacklist/sslipblacklist.csv
      - ABUSESSL_INTERVAL=360
    depends_on:
      opencti:
        condition: service_healthy

  connector-yara:
    image: opencti/connector-yara:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${YARA_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=YARA
      - CONNECTOR_SCOPE=Artifact
      - CONNECTOR_AUTO=true
      - CONNECTOR_CONFIDENCE_LEVEL=80
      - CONNECTOR_LOG_LEVEL=info
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-misp-feed-botvrij:
    image: opencti/connector-misp-feed:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${MISP_FEED_BOTVRIJ_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=MISP Feed Botvrij
      - CONNECTOR_SCOPE=misp-feed
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_DURATION_PERIOD=PT1H
      - MISP_FEED_SOURCE_TYPE=url
      - MISP_FEED_URL=${MISP_FEED_BOTVRIJ_URL}
      - MISP_FEED_SSL_VERIFY=true
      - MISP_FEED_IMPORT_FROM_DATE=${MISP_FEED_IMPORT_FROM_DATE}
      - MISP_FEED_CREATE_REPORTS=true
      - MISP_FEED_REPORT_TYPE=misp-event
      - MISP_FEED_CREATE_INDICATORS=true
      - MISP_FEED_CREATE_OBSERVABLES=true
      - MISP_FEED_CREATE_OBJECT_OBSERVABLES=true
      - MISP_FEED_CREATE_TAGS_AS_LABELS=true
    depends_on:
      opencti:
        condition: service_healthy

  connector-first-epss:
    image: opencti/connector-first-epss:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${FIRST_EPSS_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=FIRST EPSS
      - CONNECTOR_SCOPE=vulnerability
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - FIRST_EPSS_API_KEY=${FIRST_EPSS_API_KEY}
    depends_on:
      opencti:
        condition: service_healthy

  connector-virustotal:
    image: opencti/connector-virustotal:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${VIRUSTOTAL_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=VirusTotal
      - CONNECTOR_SCOPE=indicator,malware
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - VIRUSTOTAL_TOKEN=${VIRUSTOTAL_TOKEN}
    depends_on:
      opencti:
        condition: service_healthy

  connector-shodan-internetdb:
    image: opencti/connector-shodan-internetdb:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${SHODAN_INTERNETDB_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=Shodan InternetDB
      - CONNECTOR_SCOPE=ipv4-addr,hostname
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - SHODAN_TOKEN=${SHODAN_TOKEN}
    depends_on:
      opencti:
        condition: service_healthy

  connector-shodan:
    image: opencti/connector-shodan:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${SHODAN_CONNECTOR_ID}
      - CONNECTOR_TYPE=INTERNAL_ENRICHMENT
      - CONNECTOR_NAME=Shodan
      - CONNECTOR_SCOPE=ipv4-addr,hostname
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=3600
      - CONNECTOR_UPDATE_EXISTING_DATA=true
      - SHODAN_TOKEN=${SHODAN_TOKEN}
    depends_on:
      opencti:
        condition: service_healthy

  connector-opencti-datasets:
    image: opencti/connector-opencti:latest
    env_file:
      - .env
    environment:
      - OPENCTI_URL=${OPENCTI_URL:-http://opencti:8080}
      - OPENCTI_TOKEN=${OPENCTI_APP__ADMIN__TOKEN}
      - CONNECTOR_ID=${OPENCTI_DATASETS_CONNECTOR_ID}
      - CONNECTOR_TYPE=EXTERNAL_IMPORT
      - CONNECTOR_NAME=OpenCTI Datasets
      - CONNECTOR_SCOPE=collection
      - CONNECTOR_LOG_LEVEL=info
      - CONNECTOR_RUN_INTERVAL=86400
      - CONNECTOR_UPDATE_EXISTING_DATA=true
    depends_on:
      opencti:
        condition: service_healthy

volumes:
  elasticsearch-data:
  minio-data:
  redis-data:
  rabbitmq-data:
  postgres-data:
  opencti-data:
  briefing-data:
  miniflux-state:
  readwise-state:
  zotero-state:
  cvelist-state:
